# Usage:
#   make run TARGET=C03            # tests dans ../C03 et exos dans ../../C03/ex*
#   make run TARGET=C03 MODE=eval  # tests dans ../C03 et exos dans ../../ex*
#   make build | make valgrind | make norm | make list | make clean

SHELL          := /bin/bash

R  		       ?= 
MODE           ?= default
CC             ?= cc
CFLAGS         := -Wall -Wextra -Werror
NAME           := test

# ---- DÃ©tection fichiers (Ã©valuÃ©e Ã  l'appel de make) -------------------------
EX_GLOB        := $(shell [ "$(MODE)" = "eval" ] && echo "../../ex*/*.c" || echo "../../$(R)/ex*/*.c")
EX_FILES       := $(shell find $(EX_GLOB) -type f -name "*.c" 2>/dev/null)
TEST_DIR       := ../$(R)
TEST_FILES     := $(shell find "$(TEST_DIR)" -maxdepth 1 -type f \( -name "main.c" -o -name "assert.c" -o -name "test_*.c" \) | sort)

# ---- Raccourcis jolis --------------------------------------------------------
define PRINT_HEADER
	@echo "ğŸ“‚ Cible:                $(R)  (mode: $(MODE))"
	@echo "ğŸ§ª Dossier tests:        $(TEST_DIR)"
	@echo "ğŸ“¦ Dossiers exos:        $(EX_GLOB)"
	@echo "ğŸ“„ Fichiers exos:" ; \
	if [ -n "$(EX_FILES)" ]; then printf '  - %s\n' $(EX_FILES); else echo "  (aucun)"; fi
	@echo "ğŸ§ª Fichiers tests:" ; \
	if [ -n "$(TEST_FILES)" ]; then printf '  - %s\n' $(TEST_FILES); else echo "  (aucun)"; fi
endef

# ---- VÃ©rifs ------------------------------------------------------------------
define CHECKS
	@if ! [[ "$(R)" =~ ^C[0-9]{2}$$ ]]; then \
		echo "âŒ Usage: make run R=CXX [MODE=eval]"; \
		exit 1; \
	fi
	@if [ -z "$(EX_FILES)" ]; then \
		echo "âŒ Aucun fichier .c d'exercice trouvÃ© dans: $(EX_GLOB)"; \
		exit 1; \
	fi
	@if [ -z "$(TEST_FILES)" ]; then \
		echo "âŒ Aucun fichier de tests trouvÃ© dans $(TEST_DIR) (main.c/assert.c/test_*.c)"; \
		exit 1; \
	fi
endef

# ---- RÃ¨gles ------------------------------------------------------------------
.PHONY: run build valgrind norm list clean help

run: build
	@echo "ğŸš€ ExÃ©cution..."
	@if command -v valgrind >/dev/null 2>&1; then \
		echo "ğŸ§  ExÃ©cution avec Valgrind..."; \
		valgrind --leak-check=full --errors-for-leak-kinds=all --error-exitcode=42 ./$(NAME) || code=$$?; \
		if [ "$$code" = "42" ]; then echo "ğŸ’¥ Memory leak detected!"; exit 42; fi; \
		exit $${code:-0}; \
	else \
		echo "âš ï¸  Valgrind indisponible, exÃ©cution simple."; \
		./$(NAME); \
	fi

build:
	$(PRINT_HEADER)
	$(CHECKS)
	@echo "ğŸ“ Lancement norminette..."
	@norminette $(EX_FILES) || true
	@echo "âš™ï¸  Compilation..."
	@$(CC) $(CFLAGS) $(TEST_FILES) $(EX_FILES) -o $(NAME)
	@echo "âœ… Binaire prÃªt: ./$(NAME)"

valgrind: build
	@echo "ğŸ§  ExÃ©cution avec Valgrind..."
	@valgrind --leak-check=full --errors-for-leak-kinds=all --error-exitcode=42 ./$(NAME)

norm:
	$(PRINT_HEADER)
	$(CHECKS)
	@echo "ğŸ“ Lancement norminette..."
	@norminette $(EX_FILES) || true

list:
	$(PRINT_HEADER)

clean:
	@rm -f $(NAME)
	@echo "ğŸ§¹ Nettoyage terminÃ©."

help:
	@echo "Cibles disponibles:"
	@echo "  make run R=C03 [MODE=eval]   -> compile + exÃ©cute (Valgrind si prÃ©sent)"
	@echo "  make build R=C03 [MODE=eval] -> compile uniquement"
	@echo "  make valgrind R=C03 [...]    -> force exÃ©cution sous Valgrind"
	@echo "  make norm R=C03 [...]        -> lance norminette sur les exos"
	@echo "  make list R=C03 [...]        -> affiche les fichiers dÃ©tectÃ©s"
	@echo "  make clean                        -> supprime le binaire"
